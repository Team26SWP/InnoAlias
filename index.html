<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Backend Test</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
section { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
textarea { width: 100%; height: 100px; }
.console { background:#f0f0f0; padding:10px; height:120px; overflow:auto; }
.player { border:1px dashed #aaa; padding:5px; margin-top:10px; }
</style>
</head>
<body>
<h1>Backend Test Page</h1>
<section id="create">
<h2>Create Game</h2>
<label>Host name: <input id="hostName" type="text"></label><br>
<label>Team count: <input id="teamCount" type="number" value="1" min="1"></label><br>
<label>Words (one per line):<br>
<textarea id="words">apple
banana
car
</textarea></label><br>
<label>Words Amount: <input id="wordsAmount" type="number" value="3" min="1"></label><br>
<label>Time for Guessing (seconds): <input id="timeForGuessing" type="number" value="60" min="1"></label><br>
<label>Tries per Player (0 for unlimited): <input id="triesPerPlayer" type="number" value="0" min="0"></label><br>
<label>Right Answers to Advance: <input id="rightAnswersToAdvance" type="number" value="1" min="1"></label><br>
<label>Rotate Masters: <input id="rotateMasters" type="checkbox"></label><br>
<button onclick="createGame()">Create Game</button>
<div>Game ID: <span id="gameId">-</span></div>
<div class="console" id="hostConsole"></div>
<label>Host Action Team ID: <input id="hostActionTeamId" type="number" value="1" min="1"></label><br>
<button onclick="startGame()">Start</button>
<button onclick="hostSkip()">Skip</button>
</section>
<section id="players">
<h2>Players</h2>
<label>Name: <input id="playerName" type="text"></label>
<label>Team: <input id="playerTeam" type="number" value="1" min="1"></label>
<button onclick="addPlayer()">Add Player</button>
<div id="playerList"></div>
</section>
<script>
const API_HTTP = `http://localhost:8000/api`;
const API_WS = `ws://localhost:8000/api`;
let gameId = null;
let hostSocket = null;
const players = [];
function log(el, msg) {
  const div = el;
  try {
    const data = JSON.parse(msg);
    div.textContent += JSON.stringify(data, null, 2) + "\n---\n";
  } catch (e) {
    div.textContent += msg + "\n";
  }
  div.scrollTop = div.scrollHeight;
}
async function createGame() {
  const hostName = document.getElementById('hostName').value || 'Host';
  const teamCount = parseInt(document.getElementById('teamCount').value) || 1;
  const words = document.getElementById('words').value.split(/\n+/).filter(w=>w.trim());
  const wordsAmount = parseInt(document.getElementById('wordsAmount').value);
  const timeForGuessing = parseInt(document.getElementById('timeForGuessing').value);
  const triesPerPlayer = parseInt(document.getElementById('triesPerPlayer').value);
  const rightAnswersToAdvance = parseInt(document.getElementById('rightAnswersToAdvance').value);
  const rotateMasters = document.getElementById('rotateMasters').checked;

  const body = {
    host_id: hostName, // Use hostName as host_id
    deck: words, // Use 'deck' as per backend model
    words_amount: wordsAmount,
    number_of_teams: teamCount, // Use 'number_of_teams' as per backend model
    time_for_guessing: timeForGuessing,
    tries_per_player: triesPerPlayer,
    right_answers_to_advance: rightAnswersToAdvance,
    rotate_masters: rotateMasters
  };
  const res = await fetch(`${API_HTTP}/game/create`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });
  const data = await res.json();
  gameId = data.id;
  document.getElementById('gameId').textContent = gameId;
  hostSocket = new WebSocket(`${API_WS}/game/${gameId}?id=${encodeURIComponent(hostName)}`);
  hostSocket.onmessage = ev=>log(document.getElementById('hostConsole'), ev.data);
}
function startGame(){ 
  const teamId = `team_${document.getElementById('hostActionTeamId').value || '1'}`;
  if(hostSocket) hostSocket.send(JSON.stringify({action:'start', team_id: teamId})); 
}
function hostSkip(){
  const teamId = `team_${document.getElementById('hostActionTeamId').value || '1'}`;
  if(hostSocket) hostSocket.send(JSON.stringify({action:'skip', team_id: teamId})); 
}
function addPlayer(){
  if(!gameId) return alert('Create game first');
  const name = document.getElementById('playerName').value || `Player${players.length+1}`;
  const team = document.getElementById('playerTeam').value || '1';
  const container = document.createElement('div');
  container.className='player';
  container.innerHTML = `<strong>${name}</strong> (team <span class="player-team">${team}</span>)<br>
    <input type="text" placeholder="guess" class="guess"><button>Guess</button> <button class="skip">Skip</button><br>
    Switch Team: <input type="number" class="switch-team-input" value="${team}" min="1"><button class="switch-team-btn">Switch</button>
    <div class="console"></div>`;
  document.getElementById('playerList').appendChild(container);
  const guessInput = container.querySelector('input.guess');
  const guessBtn = container.querySelector('button');
  const skipBtn = container.querySelectorAll('button')[1];
  const switchTeamInput = container.querySelector('input.switch-team-input');
  const switchTeamBtn = container.querySelector('button.switch-team-btn');
  const playerTeamSpan = container.querySelector('span.player-team');
  const consoleEl = container.querySelector('div.console');
  const ws = new WebSocket(`${API_WS}/game/player/${gameId}?name=${encodeURIComponent(name)}&team_id=team_${team}`);
  ws.onmessage = ev=>log(consoleEl, ev.data);
  guessBtn.onclick=()=>{ws.send(JSON.stringify({action:'guess', guess:guessInput.value})); guessInput.value='';};
  skipBtn.onclick=()=>{ws.send(JSON.stringify({action:'skip'}));};
  switchTeamBtn.onclick=()=>{
    const newTeam = switchTeamInput.value;
    ws.send(JSON.stringify({action:'switch_team', new_team_id: `team_${newTeam}`}));
    playerTeamSpan.textContent = newTeam;
  };
  players.push(ws);
}
</script>
</body>
</html>