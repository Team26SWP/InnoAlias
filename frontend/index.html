<html>
<head>
    <meta charset="utf-8">
    <title>Alias Game Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        section { margin-bottom: 20px; }
        .player { border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
        #messages { border: 1px solid #ccc; padding: 10px; height: 150px; overflow-y: auto; }
        .masterWord { font-weight: bold; color: green; }
    </style>
</head>
<body>
<h1>Alias Game Test</h1>
<section>
    <h2>Create Game</h2>
    <textarea id="words" rows="4" cols="50" placeholder="comma separated words"></textarea><br>
    <label><input type="radio" name="mode" value="single" checked> Single game master</label>
    <label><input type="radio" name="mode" value="rotate"> Different game masters</label><br>
    <button id="create">Create</button>
    <div id="gameId"></div>
</section>
<section>
    <h2>Host Game</h2>
    <input id="hostGameId" placeholder="game id">
    <input id="hostName" placeholder="your name">
    <button id="connectHost">Connect</button>
    <button id="start" disabled>Start</button>
    <button id="skip" disabled>Skip</button>
    <div id="currentWord"></div>
    <div id="expires"></div>
    <div id="currentMaster"></div>
    <div id="playerList"></div>
    <div id="correctInfo"></div>
</section>
<section>
    <h2>Join as Player(s)</h2>
    <button id="addPlayer">Add Player</button>
    <div id="players"></div>
</section>
<pre id="messages"></pre>
<script>
const hostUrl = "ws://localhost:8000/api/game/";
let hostSocket = null;
let hostPlayerName = '';
let hostPlayerSection = null;
let currentMode = 'single';

function logMessage(msg) {
    const pre = document.getElementById('messages');
    pre.textContent += msg + '\n';
    pre.scrollTop = pre.scrollHeight;
}

document.getElementById('create').onclick = async () => {
    const words = document.getElementById('words').value.split(',').map(w => w.trim()).filter(Boolean);
    const mode = document.querySelector('input[name="mode"]:checked').value;
    currentMode = mode;
    const res = await fetch('http://localhost:8000/api/game/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        // for example
        body: JSON.stringify({
            remaining_words: words,
            tries_per_player: 3,
            right_answers_to_advance: 3,
            rotate_masters: mode === 'rotate'
        })
    });
    const data = await res.json();
    document.getElementById('gameId').textContent = 'Game ID: ' + data.id;
    document.getElementById('hostGameId').value = data.id;
    document.querySelectorAll('.playerGameId').forEach(inp => inp.value = data.id);
};

document.getElementById('connectHost').onclick = () => {
    const id = document.getElementById('hostGameId').value.trim();
    if (!id) return;
    hostPlayerName = document.getElementById('hostName').value.trim();
    const qs = hostPlayerName ? '?name=' + encodeURIComponent(hostPlayerName) : '';
    hostSocket = new WebSocket(hostUrl + id + qs);
    hostSocket.onmessage = evt => {
        const data = JSON.parse(evt.data);
        document.getElementById('currentWord').textContent = 'Word: ' + (data.current_word || '');
        document.getElementById('expires').textContent = data.expires_at ? 'Expires: ' + data.expires_at : '';
        document.getElementById('currentMaster').textContent = data.current_master ? 'Current master: ' + data.current_master : '';
        document.getElementById('playerList').textContent =
            'Players: ' + (data.players ? data.players.join(', ') : '');
        document.getElementById('correctInfo').textContent =
            'Correct: ' + data.current_correct + ' / ' + data.right_answers_to_advance;
        document.getElementById('start').disabled = data.state !== 'pending';
        const skipDisabled =
            data.state !== 'in_progress' ||
            (data.current_master && data.current_master !== hostPlayerName);
        document.getElementById('skip').disabled = skipDisabled;
        logMessage('Host state: ' + evt.data);
    };
    hostSocket.onopen = () => {
        logMessage('Host connected');
        if (currentMode === 'rotate' && hostPlayerName) {
            hostPlayerSection = createPlayerSection(hostPlayerName, id, true);
        }
    };
    hostSocket.onclose = () => {
        logMessage('Host disconnected');
    };
};

document.getElementById('skip').onclick = () => {
    if (hostSocket) hostSocket.send(JSON.stringify({ action: 'skip' }));
};

document.getElementById('start').onclick = () => {
    if (hostSocket) hostSocket.send(JSON.stringify({ action: 'start' }));
};

function createPlayerSection(defaultName = '', defaultId = '', autoJoin = false) {
    const container = document.createElement('div');
    container.className = 'player';
    container.innerHTML = `
        <input class="playerName" placeholder="your name">
        <input class="playerGameId" placeholder="game id">
        <button class="join">Join</button><br>
        <input class="guessInput" placeholder="your guess" disabled>
        <button class="sendGuess" disabled>Guess</button>
        <div class="masterArea" style="display:none">You are the master! Word: <span class="masterWord"></span> <button class="masterSkip">Skip</button></div>
        <div class="playerList"></div>
        <div class="scores"></div>
        <div class="tries"></div>
    `;
    document.getElementById('players').appendChild(container);

    let socket = null;
    const joinBtn = container.querySelector('.join');
    const guessInput = container.querySelector('.guessInput');
    const sendGuess = container.querySelector('.sendGuess');
    const masterArea = container.querySelector('.masterArea');
    const masterWordEl = container.querySelector('.masterWord');
    const masterSkip = container.querySelector('.masterSkip');
    const nameInput = container.querySelector('.playerName');
    const idInput = container.querySelector('.playerGameId');
    nameInput.value = defaultName;
    idInput.value = defaultId;

    const join = () => {
        const id = idInput.value.trim();
        const name = nameInput.value.trim();
        if (!id || !name) return;
        socket = new WebSocket(hostUrl + 'player/' + id + '/?name=' + encodeURIComponent(name));
        socket.onmessage = evt => {
            const data = JSON.parse(evt.data);
            container.querySelector('.playerList').textContent =
                'Players: ' + (data.players ? data.players.join(', ') : '');
            container.querySelector('.scores').textContent = 'Scores: ' + JSON.stringify(data.scores || {});
            const playing = data.state === 'in_progress';
            let disabled = !playing;
            if (typeof data.tries_left === 'number') {
                container.querySelector('.tries').textContent = 'Tries left: ' + data.tries_left;
                if (playing && data.tries_left <= 0) disabled = true;
            }

            const isMaster = data.current_master === name;
            masterArea.style.display = isMaster ? 'block' : 'none';
            masterWordEl.textContent = isMaster ? (data.current_word || '') : '';
            masterSkip.style.display = isMaster ? 'inline' : 'none';
            if (isMaster) {
                disabled = true;
            }

            guessInput.disabled = disabled;
            sendGuess.disabled = disabled;
            if (!disabled) guessInput.focus();
            logMessage('Player ' + name + ' state: ' + evt.data);
        };
        socket.onopen = () => logMessage('Player ' + name + ' connected');
        socket.onclose = () => {
            guessInput.disabled = true;
            sendGuess.disabled = true;
            masterArea.style.display = 'none';
            masterSkip.style.display = 'none';
            logMessage('Player ' + name + ' disconnected');
        };
    };

    joinBtn.onclick = join;

    if (autoJoin) {
        join();
    }

    sendGuess.onclick = () => {
        const guess = guessInput.value.trim();
        if (socket && guess) {
            socket.send(JSON.stringify({ action: 'guess', guess }));
            guessInput.value = '';
        }
    };

    masterSkip.onclick = () => {
        if (socket) {
            socket.send(JSON.stringify({ action: 'skip' }));
        }
    };

    guessInput.addEventListener('keyup', evt => {
        if (evt.key === 'Enter') {
            sendGuess.click();
        }
    });

    return container;
}

createPlayerSection();
document.getElementById('addPlayer').onclick = createPlayerSection;

function log(msg) {
    console.warn('Deprecated log function used');
    logMessage(msg);
}
</script>
</body>
</html>